<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SpillTea ‚òï</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
 --bg:#121212;
 --card:#1e1e1e;
 --accent:#8b5e34;
}
body{
 margin:0;
 background:var(--bg);
 color:#fff;
 font-family:system-ui;
}
header{
 padding:1rem;
 background:#1a1a1a;
 display:flex;
 justify-content:space-between;
 align-items:center;
 position:sticky;
 top:0;
}
button{
 background:var(--accent);
 border:none;
 color:#fff;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
}
.container{
 padding:1rem;
 padding-bottom:6rem;
}
.card{
 background:var(--card);
 padding:1rem;
 border-radius:12px;
 margin-bottom:1rem;
}
textarea,input{
 width:100%;
 background:#2a2a2a;
 border:none;
 color:#fff;
 padding:.6rem;
 border-radius:8px;
}
small{color:#aaa}
nav{
 position:fixed;
 bottom:0;
 width:100%;
 background:#1a1a1a;
 display:flex;
 justify-content:space-around;
 padding:.8rem 0;
}

/* modal */
.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.7);
 display:flex;
 justify-content:center;
 align-items:center;
}
.modal-box{
 background:#1e1e1e;
 padding:1rem;
 border-radius:12px;
 width:90%;
 max-width:320px;
}
.hidden{display:none}
</style>
</head>

<body>

<header>
 <h3>SpillTea ‚òï</h3>
 <button id="authBtn">Login</button>
</header>

<div class="container">

<div id="spillBox" class="hidden">
 <textarea id="teaText" placeholder="Spill your tea ‚òï"></textarea><br><br>
 <button id="spillBtn">Spill</button>
 <hr>
</div>

<div id="feed"></div>

</div>

<nav>
 <span onclick="loadFeed()">üè†</span>
</nav>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal hidden">
 <div class="modal-box">
  <h3>Complete Profile</h3><br>
  <input id="username" placeholder="Username"><br><br>
  <input id="bio" placeholder="Bio"><br><br>
  <input id="dob" type="date"><br><br>
  <button onclick="saveProfile()">Save</button>
 </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// üî• Firebase config (yours)
firebase.initializeApp({
 apiKey: "AIzaSyBsCftGcy-dH8RxxP2UxKoGG4DapRHHASo",
 authDomain: "spilltea-54aa8.firebaseapp.com",
 projectId: "spilltea-54aa8"
});

const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

// DOM
const authBtn = document.getElementById("authBtn");
const spillBox = document.getElementById("spillBox");
const feed = document.getElementById("feed");
const spillBtn = document.getElementById("spillBtn");
const teaText = document.getElementById("teaText");
const modal = document.getElementById("profileModal");

// AUTH STATE
auth.onAuthStateChanged(async user=>{
 if(user){
  authBtn.innerText = "Logout";
  spillBox.classList.remove("hidden");

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists){
   modal.classList.remove("hidden");
  }

  loadFeed();
 }else{
  authBtn.innerText = "Login";
  spillBox.classList.add("hidden");
 }
});

// LOGIN
authBtn.onclick = ()=>{
 auth.currentUser
 ? auth.signOut()
 : auth.signInWithPopup(provider);
};

// SAVE PROFILE ‚úÖ GUARANTEED WORKING
async function saveProfile(){
 const user = auth.currentUser;
 if(!user) return alert("Not logged in");

 const username = document.getElementById("username").value.trim();
 const bio = document.getElementById("bio").value.trim();
 const dob = document.getElementById("dob").value;

 if(username.length < 3){
  alert("Username too short");
  return;
 }

 await db.collection("users").doc(user.uid).set({
  username,
  bio,
  dob,
  followers:0,
  posts:0,
  createdAt:Date.now()
 },{merge:true});

 modal.classList.add("hidden");
}

// SPILL TEA
spillBtn.onclick = async ()=>{
 if(!auth.currentUser) return;

 const text = teaText.value.trim();
 if(!text) return;

 await db.collection("posts").add({
  text,
  uid: auth.currentUser.uid,
  time: Date.now(),
  likes:0
 });

 await db.collection("users")
 .doc(auth.currentUser.uid)
 .update({posts:firebase.firestore.FieldValue.increment(1)});

 teaText.value="";
};

// LOAD FEED (reload safe)
function loadFeed(){
 db.collection("posts")
 .orderBy("time","desc")
 .onSnapshot(snap=>{
  feed.innerHTML="";
  snap.forEach(doc=>{
   const p = doc.data();
   feed.innerHTML += `
    <div class="card">
     <p>${p.text}</p>
     <small>${new Date(p.time).toLocaleString()}</small>
    </div>
   `;
  });
 });
}
</script>

</body>
</html>
