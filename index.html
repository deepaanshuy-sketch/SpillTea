<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SpillTea â˜•</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;background:#0f0f0f;color:#fff;font-family:system-ui}
header,nav{background:#161616;padding:12px;display:flex;justify-content:space-between;align-items:center}
button{background:#ffb703;border:none;padding:8px 14px;border-radius:20px;cursor:pointer}
.page{display:none;padding:12px}
.page.active{display:block}
.card{background:#1e1e1e;padding:12px;border-radius:14px;margin:10px 0}
textarea,input{width:100%;padding:10px;border-radius:10px;border:none;margin-bottom:8px}
small{color:#aaa}
</style>
</head>

<body>

<header>
<b>â˜• SpillTea</b>
<button id="authBtn">Login</button>
</header>

<!-- HOME -->
<div id="home" class="page active">
<textarea id="teaText" placeholder="Spill tea..."></textarea>
<button id="spillBtn">Spill</button>
<div id="feed"></div>
</div>

<!-- FOLLOWERS -->
<div id="followers" class="page">
<h3>Followers Tea</h3>
<div id="followersFeed"></div>
</div>

<!-- BROWSE -->
<div id="browse" class="page">
<input id="searchUid" placeholder="Search user UID">
<button id="followBtn">Follow</button>
</div>

<!-- GCs -->
<div id="gcs" class="page">
<input id="gcName" placeholder="Group name">
<button id="createGcBtn">Create GC</button>
<div id="gcList"></div>
<div id="gcChat"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
<input id="username" placeholder="Username">
<textarea id="bio" placeholder="Your bio"></textarea>
<button id="saveProfileBtn">Save</button>
<p id="stats"></p>
<div id="myPosts"></div>
</div>

<nav>
<button onclick="go('home')">ğŸ </button>
<button onclick="go('followers')">ğŸ‘¥</button>
<button onclick="go('browse')">ğŸ”</button>
<button onclick="go('gcs')">ğŸ’¬</button>
<button onclick="go('profile')">ğŸ‘¤</button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
 apiKey:"AIzaSyBsCftGcy-dH8RxxP2UxKoGG4DapRHHASo",
 authDomain:"spilltea-54aa8.firebaseapp.com",
 projectId:"spilltea-54aa8"
});

const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

let me = null;
let currentGC = null;

/* ğŸ”— DOM */
const authBtn = document.getElementById("authBtn");
const spillBtn = document.getElementById("spillBtn");
const teaText = document.getElementById("teaText");
const feed = document.getElementById("feed");
const followersFeed = document.getElementById("followersFeed");
const searchUid = document.getElementById("searchUid");
const followBtn = document.getElementById("followBtn");
const gcName = document.getElementById("gcName");
const createGcBtn = document.getElementById("createGcBtn");
const gcList = document.getElementById("gcList");
const gcChat = document.getElementById("gcChat");
const username = document.getElementById("username");
const bio = document.getElementById("bio");
const stats = document.getElementById("stats");
const myPosts = document.getElementById("myPosts");

/* ğŸ” AUTH STATE */
auth.onAuthStateChanged(user=>{
 me = user;
 authBtn.innerText = user ? "Logout" : "Login";
 if(user){
  loadFeed();
  loadFollowersFeed();
  loadProfile();
  loadGCs();
 }
});

/* ğŸ” LOGIN / LOGOUT (FIXED) */
authBtn.onclick = ()=>{
 if(me){
  auth.signOut();
 }else{
  auth.signInWithPopup(provider);
 }
};

/* ğŸ§­ NAV */
function go(p){
 document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
 document.getElementById(p).classList.add("active");
}

/* â˜• POST TEA */
spillBtn.onclick = ()=>{
 if(!me) return alert("Login first");
 const text = teaText.value.trim();
 if(!text) return;

 db.collection("teas").add({
  text,
  uid: me.uid,
  time: Date.now()
 });

 teaText.value = "";
};

/* ğŸ“° FEED */
function loadFeed(){
 db.collection("teas").orderBy("time","desc")
 .onSnapshot(s=>{
  feed.innerHTML="";
  s.forEach(d=>{
   feed.innerHTML += `
   <div class="card">
    <p>${d.data().text}</p>
    <small>${new Date(d.data().time).toLocaleString()}</small>
   </div>`;
  });
 });
}

/* ğŸ‘¥ FOLLOW */
followBtn.onclick = ()=>{
 if(!me) return alert("Login first");
 const uid = searchUid.value.trim();
 if(!uid) return;

 db.collection("follows").doc(me.uid+"_"+uid)
 .set({from:me.uid,to:uid});

 alert("Followed");
};

/* ğŸ‘¥ FOLLOWERS FEED */
function loadFollowersFeed(){
 db.collection("follows").where("from","==",me.uid)
 .onSnapshot(s=>{
  followersFeed.innerHTML="";
  s.forEach(f=>{
   db.collection("teas").where("uid","==",f.data().to)
   .onSnapshot(t=>{
    t.forEach(d=>{
     followersFeed.innerHTML += `
     <div class="card">${d.data().text}</div>`;
    });
   });
  });
 });
}

/* ğŸ‘¤ PROFILE */
function loadProfile(){
 db.collection("users").doc(me.uid).onSnapshot(d=>{
  if(d.exists){
   username.value = d.data().username || "";
   bio.value = d.data().bio || "";
  }
 });

 db.collection("teas").where("uid","==",me.uid)
 .onSnapshot(s=>{
  stats.innerText = "Posts: " + s.size;
  myPosts.innerHTML="";
  s.forEach(d=>{
   myPosts.innerHTML += `<div class="card">${d.data().text}</div>`;
  });
 });
}

document.getElementById("saveProfileBtn").onclick=()=>{
 if(!me) return;
 db.collection("users").doc(me.uid)
 .set({username:username.value,bio:bio.value},{merge:true});
 alert("Saved");
};

/* ğŸ’¬ GCs */
createGcBtn.onclick = ()=>{
 if(!me) return alert("Login first");
 const name = gcName.value.trim();
 if(!name) return;

 db.collection("groups").add({
  name,
  members:[me.uid],
  created:Date.now()
 });

 gcName.value="";
};

function loadGCs(){
 db.collection("groups")
 .where("members","array-contains",me.uid)
 .onSnapshot(s=>{
  gcList.innerHTML="";
  s.forEach(d=>{
   gcList.innerHTML += `
   <button onclick="openGC('${d.id}')">${d.data().name}</button><br>`;
  });
 });
}

function openGC(id){
 currentGC=id;
 gcChat.innerHTML="";
 db.collection("messages")
 .where("gid","==",id)
 .orderBy("time")
 .onSnapshot(s=>{
  gcChat.innerHTML="";
  s.forEach(m=>{
   gcChat.innerHTML += `<div class="card">${m.data().text}</div>`;
  });
 });
}
</script>

</body>
</html>
