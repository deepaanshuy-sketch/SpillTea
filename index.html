<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SpillTea ‚òï</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#0f0f0f;color:#fff;font-family:system-ui}
header,nav{background:#161616;padding:12px;display:flex;justify-content:space-between;align-items:center}
button{background:#ffb703;border:none;padding:8px 14px;border-radius:20px;cursor:pointer}
.page{display:none;padding:12px}
.page.active{display:block}
.card{background:#1e1e1e;padding:12px;border-radius:16px;margin:10px 0}
textarea,input{width:100%;padding:10px;border-radius:10px;border:none;margin:6px 0}
small{color:#aaa}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
.modal-content{background:#1e1e1e;padding:20px;border-radius:16px;width:90%;max-width:400px}
.like{cursor:pointer}
</style>
</head>

<body>

<header>
<b>‚òï SpillTea</b>
<button id="authBtn">Login</button>
</header>

<!-- HOME -->
<div id="home" class="page active">
<textarea id="teaText" placeholder="Spill tea‚Ä¶ use @username"></textarea>
<button id="spillBtn">Spill</button>
<div id="feed"></div>
</div>

<!-- GCs -->
<div id="gcs" class="page">
<input id="gcName" placeholder="Group name">
<button id="createGC">Create GC</button>
<div id="gcList"></div>
<div id="gcChat"></div>
<input id="gcMsg" placeholder="Message">
<button id="sendMsg">Send</button>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
<p id="profileStats"></p>
</div>

<nav>
<button onclick="go('home')">üè†</button>
<button onclick="go('gcs')">üí¨</button>
<button onclick="go('profile')">üë§</button>
</nav>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal" style="display:none">
<div class="modal-content">
<h3>Complete Profile</h3>
<input id="username" placeholder="Username">
<textarea id="bio" placeholder="Bio"></textarea>
<input id="dob" type="date">
<button onclick="saveProfile()">Save</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBsCftGcy-dH8RxxP2UxKoGG4DapRHHASo",
 authDomain:"spilltea-54aa8.firebaseapp.com",
 projectId:"spilltea-54aa8"
});

const auth=firebase.auth(), db=firebase.firestore();
let me=null, currentGC=null;

const authBtn=authBtn=document.getElementById("authBtn");
const feed=document.getElementById("feed");

auth.onAuthStateChanged(u=>{
 me=u;
 authBtn.innerText=u?"Logout":"Login";
 if(u){
  checkProfile();
  loadFeed();
  loadGCs();
 }
});

authBtn.onclick=()=> me?auth.signOut():auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

function go(p){
 document.querySelectorAll(".page").forEach(x=>x.classList.remove("active"));
 document.getElementById(p).classList.add("active");
}

function checkProfile(){
 db.collection("users").doc(me.uid).get().then(d=>{
  if(!d.exists || !d.data().username){
   profileModal.style.display="flex";
  }
 });
}

function saveProfile(){
 db.collection("users").doc(me.uid).set({
  username:username.value,
  bio:bio.value,
  dob:dob.value
 });
 profileModal.style.display="none";
}

spillBtn.onclick=()=>{
 if(!me) return alert("Login first");
 db.collection("posts").add({
  text:teaText.value,
  uid:me.uid,
  likes:[],
  time:Date.now()
 });
 teaText.value="";
};

function loadFeed(){
 db.collection("posts").orderBy("time","desc")
 .onSnapshot(s=>{
  feed.innerHTML="";
  s.forEach(d=>{
   const p=d.data();
   feed.innerHTML+=`
   <div class="card">
    <p>${p.text}</p>
    <span class="like" onclick="likePost('${d.id}')">
     ‚ù§Ô∏è ${p.likes.length}
    </span>
   </div>`;
  });
 });
}

function likePost(id){
 const ref=db.collection("posts").doc(id);
 ref.get().then(d=>{
  const likes=d.data().likes||[];
  const updated=likes.includes(me.uid)
   ?likes.filter(x=>x!==me.uid)
   :[...likes,me.uid];
  ref.update({likes:updated});
 });
}

/* GCs */
createGC.onclick=()=>{
 db.collection("groups").add({name:gcName.value,members:[me.uid]});
};

function loadGCs(){
 db.collection("groups")
 .where("members","array-contains",me.uid)
 .onSnapshot(s=>{
  gcList.innerHTML="";
  s.forEach(d=>{
   gcList.innerHTML+=`<button onclick="openGC('${d.id}')">${d.data().name}</button>`;
  });
 });
}

function openGC(id){
 currentGC=id;
 db.collection("groups").doc(id).collection("messages")
 .orderBy("time")
 .onSnapshot(s=>{
  gcChat.innerHTML="";
  s.forEach(m=>gcChat.innerHTML+=`<div class="card">${m.data().text}</div>`);
 });
}

sendMsg.onclick=()=>{
 db.collection("groups").doc(currentGC)
 .collection("messages").add({text:gcMsg.value,time:Date.now()});
 gcMsg.value="";
};
</script>

</body>
 </html>
