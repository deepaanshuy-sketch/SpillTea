<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SpillTea ‚òï</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
 --bg:#0f0f0f;--card:#1c1c1c;--accent:#c08457;--muted:#aaa;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui}
header{
 position:sticky;top:0;z-index:10;
 background:#141414;padding:1rem;
 display:flex;justify-content:space-between;align-items:center
}
button{
 background:var(--accent);border:none;color:#fff;
 padding:8px 14px;border-radius:8px;cursor:pointer
}
.container{padding:1rem;padding-bottom:5rem}
.card{
 background:var(--card);border-radius:14px;
 padding:1rem;margin-bottom:1rem
}
textarea,input{
 width:100%;border-radius:8px;border:none;
 padding:.6rem;background:#222;color:#fff
}
small{color:var(--muted)}
.actions{display:flex;gap:1rem;margin-top:.5rem}
.nav{
 position:fixed;bottom:0;width:100%;
 background:#141414;display:flex;justify-content:space-around;padding:.7rem 0
}
.nav span{opacity:.6;cursor:pointer}
.nav .active{opacity:1}
.hidden{display:none}
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.7);
 display:flex;align-items:center;justify-content:center;z-index:20
}
.modal .box{
 background:#1e1e1e;padding:1rem;border-radius:12px;width:90%;max-width:400px
}
.comment{border-top:1px solid #333;padding-top:.5rem;margin-top:.5rem}
.notif{border-bottom:1px solid #333;padding:.6rem 0}
</style>
</head>
<body>

<header>
 <b>SpillTea ‚òï</b>
 <button id="authBtn">Login</button>
</header>

<div class="container">

<!-- SPILL -->
<div id="spillBox" class="card hidden">
 <textarea id="teaText" placeholder="Spill your tea ‚òï"></textarea><br><br>
 <button id="spillBtn">Spill</button>
</div>

<!-- PAGES -->
<div id="home"></div>
<div id="notifications" class="hidden"></div>
<div id="groups" class="hidden"></div>
<div id="profile" class="hidden"></div>

</div>

<!-- NAV -->
<div class="nav">
 <span onclick="showPage('home')" class="active">üè†</span>
 <span onclick="showPage('notifications')">üîî</span>
 <span onclick="showPage('groups')">üí¨</span>
 <span onclick="showPage('profile')">üë§</span>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal hidden">
 <div class="box">
  <h3>Complete Profile</h3>
  <input id="username" placeholder="Username"><br><br>
  <input id="bio" placeholder="Bio"><br><br>
  <input id="dob" type="date"><br><br>
  <button onclick="saveProfile()">Save</button>
 </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyBsCftGcy-dH8RxxP2UxKoGG4DapRHHASo",
 authDomain: "spilltea-54aa8.firebaseapp.com",
 projectId: "spilltea-54aa8"
});

const auth=firebase.auth(),db=firebase.firestore();
const provider=new firebase.auth.GoogleAuthProvider();

const authBtn=document.getElementById("authBtn");
const spillBox=document.getElementById("spillBox");
const home=document.getElementById("home");
const notifBox=document.getElementById("notifications");
const groups=document.getElementById("groups");
const profile=document.getElementById("profile");
const modal=document.getElementById("profileModal");

let currentUser=null;

auth.onAuthStateChanged(async user=>{
 if(user){
  currentUser=user;
  authBtn.innerText="Logout";
  spillBox.classList.remove("hidden");
  await checkProfile();
  loadFeed();
  loadNotifications();
 }else{
  currentUser=null;
  authBtn.innerText="Login";
  spillBox.classList.add("hidden");
 }
});

authBtn.onclick=()=>auth.currentUser?auth.signOut():auth.signInWithRedirect(provider);

// PROFILE
async function checkProfile(){
 const ref=db.collection("users").doc(currentUser.uid);
 const snap=await ref.get();
 if(!snap.exists) modal.classList.remove("hidden");
}
async function saveProfile(){
 const u = document.getElementById("username").value.trim();
 const b = document.getElementById("bio").value.trim();
 const d = document.getElementById("dob").value;

 if(!u){
  alert("Username required");
  return;
 }

 try{
  await db.collection("users").doc(currentUser.uid).set({
   username: u,
   bio: b,
   dob: d,
   followers: 0,
   posts: 0,
   createdAt: Date.now()
  }, { merge: true });

  modal.classList.add("hidden");
  alert("Profile saved ‚òï");

 }catch(err){
  alert("Save failed");
  console.error(err);
 }
}


// POST
spillBtn.onclick=()=>{
 const text=teaText.value.trim();
 if(!text) return;
 db.collection("posts").add({
  text,uid:currentUser.uid,time:Date.now(),
  likes:[],commentCount:0
 });
 teaText.value="";
};

// FEED
function loadFeed(){
 db.collection("posts").orderBy("time","desc")
 .onSnapshot(snap=>{
  home.innerHTML="";
  snap.forEach(d=>{
   const p=d.data();
   const liked=p.likes.includes(currentUser.uid);
   home.innerHTML+=`
   <div class="card">
    <p>${p.text}</p>
    <div class="actions">
     <span onclick="toggleLike('${d.id}',${liked})">‚ù§Ô∏è ${p.likes.length}</span>
     <span onclick="openComments('${d.id}')">üí¨ ${p.commentCount||0}</span>
    </div>
    <div id="c-${d.id}"></div>
   </div>`;
  });
 });
}

function toggleLike(id,liked){
 const ref=db.collection("posts").doc(id);
 ref.update({
  likes: liked
   ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
   : firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
 });
 if(!liked){
  db.collection("notifications").doc(currentUser.uid)
  .collection("items").add({text:"Someone liked your tea ‚òï",time:Date.now()});
 }
}

// COMMENTS
function openComments(id){
 const box=document.getElementById("c-"+id);
 if(box.innerHTML) return box.innerHTML="";
 box.innerHTML=`
 <input placeholder="Write comment" onkeydown="if(event.key==='Enter')addComment('${id}',this)">
 <div id="cl-${id}"></div>`;
 db.collection("posts").doc(id).collection("comments")
 .orderBy("time").onSnapshot(s=>{
  const l=document.getElementById("cl-"+id);l.innerHTML="";
  s.forEach(c=>l.innerHTML+=`<div class="comment">${c.data().text}</div>`);
 });
}

function addComment(id,input){
 const text=input.value.trim(); if(!text) return;
 db.collection("posts").doc(id).collection("comments").add({
  text,time:Date.now(),uid:currentUser.uid
 });
 db.collection("posts").doc(id)
 .update({commentCount:firebase.firestore.FieldValue.increment(1)});
 input.value="";
}

// NOTIFICATIONS
function loadNotifications(){
 db.collection("notifications").doc(currentUser.uid)
 .collection("items").orderBy("time","desc")
 .onSnapshot(s=>{
  notifBox.innerHTML="";
  s.forEach(n=>notifBox.innerHTML+=
   `<div class="notif">${n.data().text}</div>`);
 });
}

// NAV
function showPage(p){
 ["home","notifications","groups","profile"].forEach(id=>{
  document.getElementById(id).classList.add("hidden");
 });
 document.getElementById(p).classList.remove("hidden");
 document.querySelectorAll(".nav span").forEach(s=>s.classList.remove("active"));
}
</script>
</body>
</html>
