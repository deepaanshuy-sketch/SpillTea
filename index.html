<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SpillTea â˜•</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;background:#0f0f0f;color:#fff;font-family:system-ui}
header,nav{background:#161616;padding:12px;display:flex;justify-content:space-between;align-items:center}
button{background:#ffb703;border:none;padding:8px 14px;border-radius:20px}
.page{display:none;padding:12px}
.page.active{display:block}
.card{background:#1e1e1e;padding:12px;border-radius:14px;margin:10px 0}
textarea,input{width:100%;padding:10px;border-radius:10px;border:none;margin-bottom:8px}
small{color:#aaa}
.tag{color:#4fc3f7}
</style>
</head>

<body>

<header>
<b>â˜• SpillTea</b>
<button id="authBtn">Login</button>
</header>

<!-- HOME -->
<div id="home" class="page active">
<textarea id="teaText" placeholder="Spill tea with #tags"></textarea>
<button onclick="postTea()">Spill</button>
<div id="feed"></div>
</div>

<!-- FOLLOWERS -->
<div id="followers" class="page">
<h3>Followers Tea</h3>
<div id="followersFeed"></div>
</div>

<!-- BROWSE -->
<div id="browse" class="page">
<input id="searchUid" placeholder="Search user UID">
<button onclick="followUser()">Follow</button>
</div>

<!-- GCs -->
<div id="gcs" class="page">
<input id="gcName" placeholder="New group name">
<button onclick="createGC()">Create GC</button>
<div id="gcList"></div>
<div id="gcChat"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="page">
<input id="username" placeholder="Username">
<textarea id="bio" placeholder="Your bio"></textarea>
<button onclick="saveProfile()">Save</button>
<p id="stats"></p>
<div id="myPosts"></div>
</div>

<nav>
<button onclick="go('home')">ğŸ </button>
<button onclick="go('followers')">ğŸ‘¥</button>
<button onclick="go('browse')">ğŸ”</button>
<button onclick="go('gcs')">ğŸ’¬</button>
<button onclick="go('profile')">ğŸ‘¤</button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBsCftGcy-dH8RxxP2UxKoGG4DapRHHASo",
 authDomain:"spilltea-54aa8.firebaseapp.com",
 projectId:"spilltea-54aa8"
});

const auth=firebase.auth();
const db=firebase.firestore();
let me=null, currentGC=null;

auth.onAuthStateChanged(u=>{
 me=u;
 authBtn.innerText=u?"Logout":"Login";
 if(u){
  loadFeed();
  loadProfile();
  loadFollowersFeed();
  loadGCs();
 }
});

authBtn.onclick=()=>{
 me?auth.signOut():auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
};

function go(p){
 document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
 document.getElementById(p).classList.add('active');
}

function postTea(){
 if(!me) return alert("Login first");
 const text=teaText.value.trim();
 if(!text) return;

 const tags=text.match(/#\w+/g)||[];

 db.collection("teas").add({
  text, tags, uid:me.uid, time:Date.now()
 });

 tags.forEach(t=>{
  db.collection("trending").doc(t)
  .set({count:firebase.firestore.FieldValue.increment(1)},{merge:true});
 });

 teaText.value="";
}

function loadFeed(){
 db.collection("teas").orderBy("time","desc")
 .onSnapshot(s=>{
  feed.innerHTML="";
  s.forEach(d=>feed.innerHTML+=teaCard(d.id,d.data()));
 });
}

function teaCard(id,p){
 return `
 <div class="card">
  <p>${p.text.replace(/#\w+/g,m=>`<span class="tag">${m}</span>`)}</p>
  <small>${new Date(p.time).toLocaleString()}</small>
 </div>`;
}

function followUser(){
 const uid=searchUid.value.trim();
 if(!uid||!me) return;
 db.collection("follows").doc(me.uid+"_"+uid)
 .set({from:me.uid,to:uid});
 alert("Followed");
}

function loadFollowersFeed(){
 db.collection("follows").where("from","==",me.uid)
 .onSnapshot(s=>{
  followersFeed.innerHTML="";
  s.forEach(f=>{
   db.collection("teas").where("uid","==",f.data().to)
   .onSnapshot(t=>{
    t.forEach(d=>followersFeed.innerHTML+=teaCard(d.id,d.data()));
   });
  });
 });
}

function saveProfile(){
 db.collection("users").doc(me.uid)
 .set({
  username:username.value,
  bio:bio.value
 },{merge:true});
 alert("Saved");
}

function loadProfile(){
 db.collection("users").doc(me.uid).onSnapshot(d=>{
  if(d.exists){
   username.value=d.data().username||"";
   bio.value=d.data().bio||"";
  }
 });

 db.collection("teas").where("uid","==",me.uid)
 .onSnapshot(s=>{
  let tags=0;
  s.forEach(d=>tags+=d.data().tags?.length||0);
  stats.innerText=`Posts: ${s.size} | ğŸ”¥ Trending mentions: ${tags}`;
  myPosts.innerHTML="";
  s.forEach(d=>myPosts.innerHTML+=teaCard(d.id,d.data()));
 });
}

function createGC(){
 const name=gcName.value.trim();
 if(!name||!me) return;
 db.collection("groups").add({
  name, members:[me.uid], created:Date.now()
 });
 gcName.value="";
}

function loadGCs(){
 db.collection("groups")
 .where("members","array-contains",me.uid)
 .onSnapshot(s=>{
  gcList.innerHTML="";
  s.forEach(d=>{
   gcList.innerHTML+=`<button onclick="openGC('${d.id}')">${d.data().name}</button><br>`;
  });
 });
}

function openGC(id){
 currentGC=id;
 gcChat.innerHTML="";
 db.collection("messages").where("gid","==",id)
 .orderBy("time")
 .onSnapshot(s=>{
  gcChat.innerHTML="";
  s.forEach(m=>{
   gcChat.innerHTML+=`<div class="card">${m.data().text}</div>`;
  });
 });
}

</script>
</body>
 </html>
